<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scripts Python</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #000;
        color: #0f0;
        text-align: center;
    }
    header {
        padding: 20px;
        font-size: 2rem;
    }
    button {
        background: #0f0;
        color: #000;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        border-radius: 5px;
    }
    #scriptList button {
        display: block;
        width: 200px;
        margin: 10px auto;
    }
    #scriptModal, #addModal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #111;
        padding: 20px;
        border: 2px solid #0f0;
        z-index: 1000;
    }
    #scriptModal pre {
        background: #000;
        color: #0f0;
        padding: 10px;
        text-align: left;
        overflow-x: auto;
    }
    #overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 500;
    }
    #adminControls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
    }
</style>
</head>
<body>

<header>Scripts Python</header>
<input type="text" id="searchInput" placeholder="Rechercher un script">
<button onclick="toggleScriptList()">Ouvrir les scripts</button>

<div id="scriptList" style="display:none;"></div>

<div id="overlay"></div>

<div id="scriptModal">
    <h2 id="modalTitle"></h2>
    <p id="modalDescription"></p>
    <pre id="modalCode"></pre>
    <button id="runButton">Exécuter le script</button>
    <button onclick="closeModal()">Fermer</button>
    <div id="adminActions"></div>
</div>

<div id="addModal">
    <h2>Ajouter un script</h2>
    <input type="text" id="newTitle" placeholder="Titre"><br><br>
    <textarea id="newDescription" placeholder="Description"></textarea><br><br>
    <textarea id="newCode" placeholder="Code"></textarea><br><br>
    <button onclick="addScript()">Valider</button>
    <button onclick="closeAddModal()">Fermer</button>
</div>

<div id="adminControls">
    <input type="text" id="adminCode" placeholder="Code admin">
    <button onclick="checkAdminCode()">Entrer</button>
    <button id="addScriptButton" style="display:none;" onclick="openAddModal()">+</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://puqthoqzlliyqkduhbhj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1cXRob3F6bGxpeXFrZHVoYmhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMDA4NDksImV4cCI6MjA3MTY3Njg0OX0.K60SelW2IM17WJdUbYmxeaCS30iEUQzomCvE1ZqYmwc";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let isAdmin = false;
let scripts = [];

async function loadScripts() {
    const { data, error } = await supabase.from('scripts').select('*');
    if (error) {
        alert("Erreur de chargement : " + error.message);
        return;
    }
    scripts = data;
    displayScripts();
}

function displayScripts(filter = "") {
    const list = document.getElementById('scriptList');
    list.innerHTML = "";
    scripts
        .filter(s => s.title.toLowerCase().includes(filter.toLowerCase()))
        .forEach(script => {
            const btn = document.createElement('button');
            btn.textContent = script.title;
            btn.onclick = () => openScript(script);
            list.appendChild(btn);
        });
}

function toggleScriptList() {
    const list = document.getElementById('scriptList');
    list.style.display = (list.style.display === "none") ? "block" : "none";
}

function openScript(script) {
    document.getElementById('modalTitle').textContent = script.title;
    document.getElementById('modalDescription').textContent = script.description;
    document.getElementById('modalCode').textContent = script.code;
    document.getElementById('overlay').style.display = "block";
    document.getElementById('scriptModal').style.display = "block";

    const adminActions = document.getElementById('adminActions');
    adminActions.innerHTML = "";

    if (isAdmin) {
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Modifier';
        editBtn.onclick = () => editScript(script.id);
        adminActions.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Supprimer';
        deleteBtn.onclick = () => deleteScript(script.id);
        adminActions.appendChild(deleteBtn);
    }

    document.getElementById('runButton').onclick = () => {
        try {
            eval(script.code);
        } catch (err) {
            alert("Erreur lors de l'exécution : " + err);
        }
    };
}

function closeModal() {
    document.getElementById('overlay').style.display = "none";
    document.getElementById('scriptModal').style.display = "none";
}

function openAddModal() {
    document.getElementById('overlay').style.display = "block";
    document.getElementById('addModal').style.display = "block";
}

function closeAddModal() {
    document.getElementById('overlay').style.display = "none";
    document.getElementById('addModal').style.display = "none";
}

async function addScript() {
    const title = document.getElementById('newTitle').value;
    const description = document.getElementById('newDescription').value;
    const code = document.getElementById('newCode').value;

    const { error } = await supabase.from('scripts').insert([{ title, description, code }]);
    if (error) {
        alert("Erreur : " + error.message);
    } else {
        closeAddModal();
        loadScripts();
    }
}

async function editScript(id) {
    const newTitle = prompt("Nouveau titre :");
    const newDescription = prompt("Nouvelle description :");
    const newCode = prompt("Nouveau code :");

    if (!newTitle || !newDescription || !newCode) return;

    const { error } = await supabase
        .from('scripts')
        .update({ title: newTitle, description: newDescription, code: newCode })
        .eq('id', id);

    if (error) {
        alert("Erreur : " + error.message);
    } else {
        loadScripts();
        closeModal();
    }
}

async function deleteScript(id) {
    if (!confirm("Voulez-vous vraiment supprimer ce script ?")) return;

    const { error } = await supabase
        .from('scripts')
        .delete()
        .eq('id', id);

    if (error) {
        alert("Erreur : " + error.message);
    } else {
        loadScripts();
        closeModal();
    }
}

function checkAdminCode() {
    const codeInput = document.getElementById('adminCode').value;
    if (codeInput === "Evalexis2013") {
        isAdmin = true;
        document.getElementById('addScriptButton').style.display = 'inline-block';
        loadScripts();
    } else {
        alert("Code incorrect");
    }
}

document.getElementById('searchInput').addEventListener('input', (e) => {
    displayScripts(e.target.value);
});

loadScripts();
</script>

</body>
</html>
